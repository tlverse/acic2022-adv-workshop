<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Optimal Individualized Treatment Regimes | [ACIC 2022] Targeted Learning in the tlverse</title>
<meta name="author" content="Mark van der Laan, Alan Hubbard, Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips">
<meta name="description" content="Ivana Malenica Based on the tmle3mopttx R package by Ivana Malenica, Jeremy Coyle, and Mark van der Laan. Updated: 2022-05-23  5.1 Learning Objectives By the end of this lesson you will be able...">
<meta name="generator" content="bookdown 0.24.1 with bs4_book()">
<meta property="og:title" content="Chapter 5 Optimal Individualized Treatment Regimes | [ACIC 2022] Targeted Learning in the tlverse">
<meta property="og:type" content="book">
<meta property="og:url" content="https://tlverse.org/tlverse-workshops/optimal-individualized-treatment-regimes.html">
<meta property="og:description" content="Ivana Malenica Based on the tmle3mopttx R package by Ivana Malenica, Jeremy Coyle, and Mark van der Laan. Updated: 2022-05-23  5.1 Learning Objectives By the end of this lesson you will be able...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Optimal Individualized Treatment Regimes | [ACIC 2022] Targeted Learning in the tlverse">
<meta name="twitter:description" content="Ivana Malenica Based on the tmle3mopttx R package by Ivana Malenica, Jeremy Coyle, and Mark van der Laan. Updated: 2022-05-23  5.1 Learning Objectives By the end of this lesson you will be able...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
</head>
<body>
<span class="math inline">
  \(\DeclareMathOperator{\expit}{expit}\)
  \(\DeclareMathOperator{\logit}{logit}\)
  \(\DeclareMathOperator*{\argmin}{\arg\!\min}\)
  \(\newcommand{\indep}{\perp\!\!\!\perp}\)
  \(\newcommand{\coloneqq}{\mathrel{=}}\)
  \(\newcommand{\R}{\mathbb{R}}\)
  \(\newcommand{\E}{\mathbb{E}}\)
  \(\newcommand{\M}{\mathcal{M}}\)
  \(\renewcommand{\P}{\mathbb{P}}\)
  \(\newcommand{\I}{\mathbb{I}}\)
  \(\newcommand{\1}{\mathbbm{1}}\)
  </span>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Causal Inference Meets Machine Learning">[ACIC 2022] Targeted Learning in the <code>tlverse</code></a>:
        <small class="text-muted">Causal Inference Meets Machine Learning</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="" href="motivation.html">Motivation</a></li>
<li><a class="" href="tlverse.html"><span class="header-section-number">1</span> Welcome to the tlverse</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">2</span> The Roadmap for Targeted Learning</a></li>
<li><a class="" href="sl3.html"><span class="header-section-number">3</span> Super Learning with sl3</a></li>
<li><a class="" href="tmle3.html"><span class="header-section-number">4</span> The TMLE Framework (Brief Review)</a></li>
<li><a class="active" href="optimal-individualized-treatment-regimes.html"><span class="header-section-number">5</span> Optimal Individualized Treatment Regimes</a></li>
<li><a class="" href="stochastic-treatment-regimes-optional.html"><span class="header-section-number">6</span> Stochastic Treatment Regimes (optional)</a></li>
<li><a class="" href="causal-mediation-analysis.html"><span class="header-section-number">7</span> Causal Mediation Analysis</a></li>
<li><a class="" href="r6.html"><span class="header-section-number">8</span> A Primer on the R6 Class System</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/tlverse/tlverse-workshops">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="optimal-individualized-treatment-regimes" class="section level1">
<h1>
<span class="header-section-number">5</span> Optimal Individualized Treatment Regimes<a class="anchor" aria-label="anchor" href="#optimal-individualized-treatment-regimes"><i class="fas fa-link"></i></a>
</h1>
<p><em>Ivana Malenica</em></p>
<p>Based on the <a href="https://github.com/tlverse/tmle3mopttx"><code>tmle3mopttx</code> <code>R</code> package</a>
by <em>Ivana Malenica, Jeremy Coyle, and Mark van der Laan</em>.</p>
<p>Updated: 2022-05-23</p>
<div id="learning-objectives-3" class="section level2">
<h2>
<span class="header-section-number">5.1</span> Learning Objectives<a class="anchor" aria-label="anchor" href="#learning-objectives-3"><i class="fas fa-link"></i></a>
</h2>
<p>By the end of this lesson you will be able to:</p>
<ol style="list-style-type: decimal">
<li>Differentiate dynamic and optimal dynamic treatment interventions from static
interventions.</li>
<li>Explain the benefits, and challenges, associated with using optimal
individualized treatment regimes in practice.</li>
<li>Contrast the impact of implementing an optimal individualized treatment
regime in the population with the impact of implementing static and dynamic
treatment regimes in the population.</li>
<li>Estimate causal effects under optimal individualized treatment regimes with
the <code>tmle3mopttx</code> <code>R</code> package.</li>
<li>Assess the mean under optimal individualized treatment with resource
constraints.</li>
<li>Implement optimal individualized treatment rules based on sub-optimal
rules, or “simple” rules, and recognize the practical benefit of these rules.</li>
<li>Construct “realistic” optimal individualized treatment regimes that respect
real data and subject-matter knowledge limitations on interventions by
only considering interventions that are supported by the data.</li>
<li>Measure variable importance as defined in terms of the optimal individualized
treatment interventions.</li>
</ol>
<hr>
</div>
<div id="introduction-1" class="section level2">
<h2>
<span class="header-section-number">5.2</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-1"><i class="fas fa-link"></i></a>
</h2>
<p>Identifying which intervention will be effective for which patient
based on lifestyle, genetic and environmental factors is a common goal in
precision medicine. One opts to administer the intervention to individuals
who will benefit from it, instead of assigning treatment on a population level.</p>
<ul>
<li><p>This aim motivates a different type of intervention, as opposed to the static
exposures we might be used to.</p></li>
<li><p>In this chapter, we learn about dynamic (individualized) interventions that
tailor the treatment decision based on the collected covariates.</p></li>
</ul>
<hr>
<p>To motivate these types of interventions, we turn to an actual randomized trial.</p>
<ul>
<li><p>The goal is to improve retention in HIV care.</p></li>
<li><p>Several interventions show efficacy – appointment reminders through text
messages, small cash incentives for on-time clinic visits, and peer health
workers.</p></li>
<li><p>We want to improve effectiveness by assigning each patient the intervention
they are most likely to benefit from.</p></li>
<li><p>We also do not want to allocate resources to individuals who would not benefit
from an intervention.</p></li>
</ul>
<p><br></p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-1"></span>
<img src="img/png/DynamicA_Illustration.png" alt="Illustration of a Dynamic Treatment Regime in a Clinical Setting" width="60%"><p class="caption">
FIGURE 5.1: Illustration of a Dynamic Treatment Regime in a Clinical Setting
</p>
</div>
<p><br></p>
<hr>
<p><br></p>
<div align="center">
In the statistics community, such a treatment strategy is
termed <strong>individualized treatment regimes</strong> (ITR). The (counterfactual) population
mean outcome under an ITR is the <strong>value of the ITR</strong>.
</div>
<p><br></p>
<ul>
<li><p>Suppose one wishes to maximize the population mean of an outcome, where for
each individual we have access to some set of measured covariates.</p></li>
<li><p>ITR with the maximal value is referred to as an <strong>optimal ITR</strong> or the
<strong>optimal individualized treatment</strong>.</p></li>
<li><p>The value of an optimal ITR is termed the <strong>optimal value</strong>, or the <strong>mean
under the optimal individualized treatment</strong>.</p></li>
<li><p>One opts to administer the intervention to individuals who will profit from
it, instead of assigning treatment on a population level.</p></li>
</ul>
<br><div align="center">
<strong>But how do we know which intervention works for which patient?</strong>
</div>
<p><br></p>
<p><br></p>
<hr>
<ul>
<li><p>In this chapter, we examine optimal individualized treatment regimes, and
estimate the mean outcome under the ITR.</p></li>
<li><p>The candidate rules are restricted to depend only on user-supplied subset of
the baseline covariates.</p></li>
<li><p>We will use <code>tmle3mopttx</code> to estimate optimal ITR and the corresponding value.</p></li>
</ul>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="data-structure-and-notation" class="section level2">
<h2>
<span class="header-section-number">5.3</span> Data Structure and Notation<a class="anchor" aria-label="anchor" href="#data-structure-and-notation"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Suppose we observe <span class="math inline">\(n\)</span> independent and identically distributed observations of
the form <span class="math inline">\(O=(W,A,Y) \sim P_0\)</span>.</p></li>
<li><p><span class="math inline">\(P_0 \in \mathcal{M}\)</span>, where <span class="math inline">\(\mathcal{M}\)</span> is the
fully nonparametric model.</p></li>
<li><p>Denote <span class="math inline">\(A \in \mathcal{A}\)</span> as categorical treatment.</p></li>
<li><p>Let
<span class="math inline">\(\mathcal{A} \equiv \{a_1, \ldots, a_{n_A} \}\)</span> and <span class="math inline">\(n_A = |\mathcal{A}|\)</span>, with
<span class="math inline">\(n_A\)</span> denoting the number of categories.</p></li>
<li><p>Denote <span class="math inline">\(Y\)</span> as the final outcome.</p></li>
<li><p><span class="math inline">\(W\)</span> a vector-valued collection of baseline covariates.</p></li>
<li><p>Finally, let <span class="math inline">\(V\)</span> be a subset of the baseline covariates <span class="math inline">\(W\)</span> that
the rule might depend on.</p></li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<ul>
<li><p>The likelihood of the data admits a factorization, implied by the time ordering of <span class="math inline">\(O\)</span>.
<span class="math display">\[\begin{align*}\label{eqn:likelihood_factorization}
p_0(O) &amp;= p_{Y,0}(Y|A,W) p_{A,0}(A|W) p_{W,0}(W) \\
       &amp;= q_{Y,0}(Y|A,W) q_{A,0}(A|W) q_{W,0}(W),
\end{align*}\]</span></p></li>
<li><p>Consequently, let
<span class="math display">\[P_{Y,0}(Y|A,W)=Q_{Y,0}(Y|A,W),\]</span> <span class="math display">\[P_{A,0}(A|W)=g_0(A|W)\]</span> and <span class="math display">\[P_{W,0}(W)=Q_{W,0}(W).\]</span></p></li>
</ul>
<p><br></p>
<ul>
<li>We also define <span class="math inline">\(\bar{Q}_{Y,0}(A,W) \equiv E_0[Y|A,W]\)</span>.</li>
</ul>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="causal-effect-of-an-oit" class="section level2">
<h2>
<span class="header-section-number">5.4</span> Causal Effect of an OIT<a class="anchor" aria-label="anchor" href="#causal-effect-of-an-oit"><i class="fas fa-link"></i></a>
</h2>
<p>We define relationships between variables with <strong>structural equations</strong>:</p>
<p><span class="math display">\[\begin{align*}
  W &amp;= f_W(U_W) \\ A &amp;= f_A(W, U_A) \\ Y &amp;= f_Y(A, W, U_Y).
\end{align*}\]</span></p>
<ul>
<li><p><span class="math inline">\(U=(U_W,U_A,U_Y)\)</span> denotes the exogenous random variables, drawn from <span class="math inline">\(U \sim P_U\)</span>.</p></li>
<li><p>The endogenous variables, written as <span class="math inline">\(O=(W,A,Y)\)</span>, correspond to the observed data.</p></li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<div align="center">
<strong>Causal effects are defined as
hypothetical interventions on SEM.</strong>
</div>
<p><br></p>
<ul>
<li><p>Consider dynamic treatment rules, denoted as <span class="math inline">\(d\)</span>, in the set of all possible rules
<span class="math inline">\(\mathcal{D}\)</span>.</p></li>
<li><p>In a point treatment setting, <span class="math inline">\(d\)</span> is a deterministic function
that takes as input <span class="math inline">\(V\)</span> and outputs a treatment decision where</p></li>
</ul>
<p><br></p>
<p><span class="math display">\[V \rightarrow d(V) \in \{a_1, \cdots, a_{n_A} \}.\]</span></p>
<p><br></p>
<hr>
<p><br></p>
<p>For a given rule <span class="math inline">\(d\)</span>, our modified system then takes the following form:</p>
<p><span class="math display">\[\begin{align*}
  W &amp;= f_W(U_W) \\ A &amp;= d(V) \\ Y_{d(V)} &amp;= f_Y(d(V), W, U_Y).
\end{align*}\]</span></p>
<p><br></p>
<ul>
<li><p>The counterfactual outcome <span class="math inline">\(Y_{d(V)}\)</span> denotes the outcome for a patient had
their treatment been assigned using the dynamic rule <span class="math inline">\(d(V)\)</span> (possibly contrary
to the fact).</p></li>
<li><p>Distribution of the counterfactual outcomes is <span class="math inline">\(P_{U,X}\)</span>, implied by the
distribution of exogenous variables <span class="math inline">\(U\)</span> and structural equations <span class="math inline">\(f\)</span>.</p></li>
<li><p>The set of all possible counterfactual distributions are encompassed by the
causal model <span class="math inline">\(\mathcal{M}^F\)</span>, where <span class="math inline">\(P_{U,X} \in \mathcal{M}^F\)</span>.</p></li>
</ul>
<p><br></p>
<div align="center">
<strong>“What is the expected outcome had every subject received treatment according to the
(optimal) rule <span class="math inline">\(d\)</span>?”</strong>
</div>
<p><br></p>
<hr>
<p><br></p>
<p>We can consider different treatment rules, all in the set <span class="math inline">\(\mathcal{D}\)</span>:</p>
<ol style="list-style-type: decimal">
<li><p>The <strong>true rule</strong>, <span class="math inline">\(d_0\)</span>, and the corresponding causal parameter
<span class="math inline">\(E_{U,X}[Y_{d_0(V)}]\)</span> denoting the expected outcome under the
true treatment rule <span class="math inline">\(d_0(V)\)</span>.</p></li>
<li><p>The <strong>estimated rule</strong>, <span class="math inline">\(d_n\)</span>, and the corresponding causal parameter
<span class="math inline">\(E_{U,X}[Y_{d_n(V)}]\)</span> denoting the expected outcome under the
estimated treatment rule <span class="math inline">\(d_n(V)\)</span>.</p></li>
</ol>
<p><br></p>
<div align="center">
In this chapter, we will focus on the value under the estimated rule <span class="math inline">\(d_n\)</span>,
a <strong>data-adaptive parameter</strong>.
</div>
<p><br></p>
<div align="center">
<strong>Note that its true value depends on the sample!</strong>
</div>
<p><br></p>
<hr>
<p><br></p>
<p>The optimal individualized rule is the rule with the maximal value:
<span class="math display">\[d_{opt}(V) \equiv \text{argmax}_{d(V) \in \mathcal{D}}
E_{P_{U,X}}[Y_{d(V)}].\]</span></p>
<p><br></p>
<p>Our causal target parameter of interest is the expected outcome under
the estimated optimal individualized rule:</p>
<p><span class="math display">\[\Psi_{d_{n, \text{opt}}(V)}(P_{U,X}) := E_{P_{U,X}}[Y_{d_{n,
\text{opt}}(V)}].\]</span></p>
<p><br></p>
<hr>
<p><br></p>
<div id="identification-and-statistical-estimand" class="section level3">
<h3>
<span class="header-section-number">5.4.1</span> Identification and Statistical Estimand<a class="anchor" aria-label="anchor" href="#identification-and-statistical-estimand"><i class="fas fa-link"></i></a>
</h3>
<div align="center">
In order for the causal quantities to be estimated from the
observed data, they need to be identified with statistical parameters.
</div>
<p><br></p>
<ul>
<li>This step of the roadmap requires me make a few assumptions:</li>
</ul>
<ol style="list-style-type: decimal">
<li><p><em>Strong ignorability</em>: <span class="math inline">\(A\)</span> independent of <span class="math inline">\(Y^{d_n(v)} \mid W\)</span>, for all <span class="math inline">\(a \in \mathcal{A}\)</span>.</p></li>
<li><p><em>Positivity (or overlap)</em>: <span class="math inline">\(P_0(\min_{a \in \mathcal{A}} g_0(a \mid W) &gt; 0) = 1\)</span></p></li>
</ol>
<p><br></p>
<hr>
<p><br></p>
<p>Under the above causal assumptions, we can identify the causal target parameter
with observed data using the G-computation formula.</p>
<ul>
<li>The value of an individualized
rule can now be expressed as</li>
</ul>
<p><span class="math display">\[E_0[Y_{d_n(V)}] = E_{0,W}[\bar{Q}_{Y,0}(A=d_n(V),W)].\]</span>
<br></p>
<div align="center">
<strong>“Mean outcome if (possibly contrary to fact), treatment was assigned according to the rule <span class="math inline">\(d_n\)</span>.”</strong>
</div>
<p><br></p>
<hr>
<p><br></p>
<ul>
<li>Finally, the statistical counterpart to the causal parameter of interest is
defined as:</li>
</ul>
<p><span class="math display">\[\psi_0 = E_{0,W}[\bar{Q}_{Y,0}(A=d_{n,\text{opt}}(V),W)].\]</span>
<br></p>
<div align="center">
<strong>“Mean outcome if (possibly contrary to fact), treatment was assigned according to the optimal rule <span class="math inline">\(d_{n,\text{opt}}\)</span>.”</strong>
</div>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="high-level-idea" class="section level3">
<h3>
<span class="header-section-number">5.4.2</span> High-level idea<a class="anchor" aria-label="anchor" href="#high-level-idea"><i class="fas fa-link"></i></a>
</h3>
<p><br></p>
<ol style="list-style-type: decimal">
<li>Learn the optimal ITR using the Super Learner.</li>
</ol>
<p><br></p>
<ol start="2" style="list-style-type: decimal">
<li>Estimate its value with the cross-validated Targeted Minimum Loss-based
Estimator (CV-TMLE).</li>
</ol>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="why-cv-tmle" class="section level3">
<h3>
<span class="header-section-number">5.4.3</span> Why CV-TMLE?<a class="anchor" aria-label="anchor" href="#why-cv-tmle"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>CV-TMLE is necessary as the non-cross-validated TMLE
is biased upward for the mean outcome under the rule, and therefore overly optimistic.</p></li>
<li><p>More generally however, using CV-TMLE allows us more freedom in estimation and therefore greater
data adaptivity, without sacrificing inference.</p></li>
</ul>
<p><br></p>
<hr>
<p><br></p>
</div>
</div>
<div id="binary-treatment" class="section level2">
<h2>
<span class="header-section-number">5.5</span> Binary Treatment<a class="anchor" aria-label="anchor" href="#binary-treatment"><i class="fas fa-link"></i></a>
</h2>
<div align="center">
<strong>How do we estimate the optimal individualized treatment regime?</strong>
</div>
<p><br></p>
<ul>
<li><p>In the case of binary treatment, a key quantity for optimal ITR is the <strong>blip</strong> function.</p></li>
<li><p>Optimal ITR assigns treatment to individuals falling in strata in which the
stratum specific average treatment effect, the blip function, is positive.</p></li>
<li><p>Consequently, it does not assign treatment to individuals for which this
quantity is negative.</p></li>
</ul>
<p><br></p>
<p>We define the blip function as:</p>
<p><span class="math display">\[\bar{Q}_0(V) \equiv E_0[Y_1-Y_0|V] \equiv E_0[\bar{Q}_{Y,0}(1,W) - \bar{Q}_{Y,0}(0,W) | V], \]</span>
or the average treatment effect within a stratum of <span class="math inline">\(V\)</span>.</p>
<p><br></p>
<p>Optimal individualized rule can now be derived as:
<span class="math display">\[d_{opt}(V) = I(\bar{Q}_{0}(V) &gt; 0).\]</span></p>
<p><br></p>
<hr>
<p><br></p>
<p>We follow the below steps in order to obtain value of the ITR:</p>
<p><br></p>
<ol style="list-style-type: decimal">
<li>Estimate <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> and <span class="math inline">\(g_0(A|W)\)</span> using <code>sl3</code>. We denote such estimates
as <span class="math inline">\(\bar{Q}_{Y,n}(A,W)\)</span> and <span class="math inline">\(g_n(A|W)\)</span>.</li>
</ol>
<p><br></p>
<ol start="2" style="list-style-type: decimal">
<li>Apply the doubly robust Augmented-Inverse Probability Weighted (A-IPW) transform to
our outcome, where we define:</li>
</ol>
<p><span class="math display">\[D_{\bar{Q}_Y,g,a}(O) \equiv \frac{I(A=a)}{g(A|W)} (Y-\bar{Q}_Y(A,W)) + \bar{Q}_Y(A=a,W)\]</span>
<br></p>
<hr>
<p><br></p>
<p>Few notes on the A-IPW transform:</p>
<ul>
<li><p>Under the randomization and positivity assumptions, we have that
<span class="math inline">\(E[D_{\bar{Q}_Y,g,a}(O) | V] = E[Y_a |V].\)</span></p></li>
<li><p>Due to the double robust nature
of the A-IPW transform, consistency of <span class="math inline">\(E[Y_a |V]\)</span> will depend on correct estimation
of either <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> or <span class="math inline">\(g_0(A|W)\)</span>.</p></li>
<li><p>In a randomized trial, we are
guaranteed a consistent estimate of <span class="math inline">\(E[Y_a |V]\)</span> even if we get <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> wrong!</p></li>
</ul>
<p><br></p>
<p>Using this transform, we can define the following contrast:</p>
<p><span class="math display">\[D_{\bar{Q}_Y,g}(O) = D_{\bar{Q}_Y,g,a=1}(O) - D_{\bar{Q}_Y,g,a=0}(O).\]</span>
<br></p>
<p>We estimate the blip function, <span class="math inline">\(\bar{Q}_{0,a}(V)\)</span>, by regressing <span class="math inline">\(D_{\bar{Q}_Y,g}(O)\)</span> on <span class="math inline">\(V\)</span>.</p>
<p><br></p>
<p>Our estimated rule is <span class="math inline">\(d(V) = \text{argmax}_{a \in \mathcal{A}} \bar{Q}_{0,a}(V)\)</span>.</p>
<hr>
<p><br></p>
<p>Finally, get the mean under the OIT:</p>
<ol start="3" style="list-style-type: decimal">
<li>We obtain inference for the mean outcome under the estimated optimal rule using CV-TMLE.</li>
</ol>
<p><br></p>
<hr>
<p><br></p>
<p>All combined:</p>
<ol style="list-style-type: decimal">
<li>Estimate <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> and <span class="math inline">\(g_0(A|W)\)</span> using <code>sl3</code>. We denote such estimates
as <span class="math inline">\(\bar{Q}_{Y,n}(A,W)\)</span> and <span class="math inline">\(g_n(A|W)\)</span>.</li>
</ol>
<p><br></p>
<ol start="2" style="list-style-type: decimal">
<li>Apply the doubly robust Augmented-Inverse Probability Weighted (A-IPW) transform to
our outcome. Our estimated rule is <span class="math inline">\(d(V) = \text{argmax}_{a \in \mathcal{A}} \bar{Q}_{0,a}(V)\)</span>.</li>
</ol>
<p><br></p>
<ol start="3" style="list-style-type: decimal">
<li>We obtain inference for the mean outcome under the estimated optimal rule using CV-TMLE.</li>
</ol>
<p><br></p>
<hr>
<p><br></p>
<div id="causal-effect-of-oit-with-binary-a" class="section level3">
<h3>
<span class="header-section-number">5.5.1</span> Causal Effect of OIT with Binary A<a class="anchor" aria-label="anchor" href="#causal-effect-of-oit-with-binary-a"><i class="fas fa-link"></i></a>
</h3>
<p>To start, let us load the packages we will use and set a seed for simulation:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/sl3">sl3</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/tmle3">tmle3</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/tmle3mopttx">tmle3mopttx</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/">devtools</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">111</span><span class="op">)</span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
<div id="simulate-data" class="section level4">
<h4>
<span class="header-section-number">5.5.1.1</span> Simulate Data<a class="anchor" aria-label="anchor" href="#simulate-data"><i class="fas fa-link"></i></a>
</h4>
<p>Our data generating distribution is of the following form:</p>
<p><span class="math display">\[W \sim \mathcal{N}(\bf{0},I_{3 \times 3})\]</span>
<span class="math display">\[P(A=1|W) = \frac{1}{1+\exp^{(-0.8*W_1)}}\]</span></p>
<p><span class="math display">\[\begin{align}
  P(Y=1|A,W) &amp;= 0.5\text{logit}^{-1}[-5I(A=1)(W_1-0.5) \\
  &amp;+ 5I(A=0)(W_1-0.5)] +0.5\text{logit}^{-1}(W_2W_3)
\end{align}\]</span></p>
<p><br></p>
<hr>
<p><br></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="optimal-individualized-treatment-regimes.html#cb70-1"></a><span class="kw">head</span>(data)</span>
<span id="cb70-2"><a href="optimal-individualized-treatment-regimes.html#cb70-2"></a>          W1       W2       W3 A Y</span>
<span id="cb70-3"><a href="optimal-individualized-treatment-regimes.html#cb70-3"></a><span class="dv">1</span><span class="op">:</span><span class="st"> </span><span class="fl">-0.591031</span> <span class="fl">-0.40168</span>  <span class="fl">0.15008</span> <span class="dv">1</span> <span class="dv">0</span></span>
<span id="cb70-4"><a href="optimal-individualized-treatment-regimes.html#cb70-4"></a><span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="fl">0.026594</span> <span class="fl">-0.37093</span>  <span class="fl">0.79472</span> <span class="dv">0</span> <span class="dv">0</span></span>
<span id="cb70-5"><a href="optimal-individualized-treatment-regimes.html#cb70-5"></a><span class="dv">3</span><span class="op">:</span><span class="st"> </span><span class="fl">-1.516553</span> <span class="fl">-0.42515</span>  <span class="fl">0.43203</span> <span class="dv">1</span> <span class="dv">0</span></span>
<span id="cb70-6"><a href="optimal-individualized-treatment-regimes.html#cb70-6"></a><span class="dv">4</span><span class="op">:</span><span class="st"> </span><span class="fl">-1.362653</span>  <span class="fl">0.44115</span>  <span class="fl">0.34370</span> <span class="dv">1</span> <span class="dv">1</span></span>
<span id="cb70-7"><a href="optimal-individualized-treatment-regimes.html#cb70-7"></a><span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="fl">1.178489</span> <span class="fl">-0.67275</span>  <span class="fl">0.38710</span> <span class="dv">1</span> <span class="dv">0</span></span>
<span id="cb70-8"><a href="optimal-individualized-treatment-regimes.html#cb70-8"></a><span class="dv">6</span><span class="op">:</span><span class="st"> </span><span class="fl">-0.934151</span>  <span class="fl">0.41669</span> <span class="fl">-0.78808</span> <span class="dv">1</span> <span class="dv">1</span></span></code></pre></div>
<ul>
<li><p>The above composes our observed data structure <span class="math inline">\(O = (W, A, Y)\)</span>.</p></li>
<li><p>Note that the mean under the OIT is <span class="math inline">\(\psi_0=0.578\)</span> for this data generating
distribution.</p></li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<p>Next, we specify the role that each variable in the data set plays as the nodes in a DAG.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="optimal-individualized-treatment-regimes.html#cb71-1"></a><span class="co"># organize data and nodes for tmle3</span></span>
<span id="cb71-2"><a href="optimal-individualized-treatment-regimes.html#cb71-2"></a>node_list &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb71-3"><a href="optimal-individualized-treatment-regimes.html#cb71-3"></a>  <span class="dt">W =</span> <span class="kw">c</span>(<span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span>),</span>
<span id="cb71-4"><a href="optimal-individualized-treatment-regimes.html#cb71-4"></a>  <span class="dt">A =</span> <span class="st">"A"</span>,</span>
<span id="cb71-5"><a href="optimal-individualized-treatment-regimes.html#cb71-5"></a>  <span class="dt">Y =</span> <span class="st">"Y"</span></span>
<span id="cb71-6"><a href="optimal-individualized-treatment-regimes.html#cb71-6"></a>)</span>
<span id="cb71-7"><a href="optimal-individualized-treatment-regimes.html#cb71-7"></a>node_list</span>
<span id="cb71-8"><a href="optimal-individualized-treatment-regimes.html#cb71-8"></a><span class="op">$</span>W</span>
<span id="cb71-9"><a href="optimal-individualized-treatment-regimes.html#cb71-9"></a>[<span class="dv">1</span>] <span class="st">"W1"</span> <span class="st">"W2"</span> <span class="st">"W3"</span></span>
<span id="cb71-10"><a href="optimal-individualized-treatment-regimes.html#cb71-10"></a></span>
<span id="cb71-11"><a href="optimal-individualized-treatment-regimes.html#cb71-11"></a><span class="op">$</span>A</span>
<span id="cb71-12"><a href="optimal-individualized-treatment-regimes.html#cb71-12"></a>[<span class="dv">1</span>] <span class="st">"A"</span></span>
<span id="cb71-13"><a href="optimal-individualized-treatment-regimes.html#cb71-13"></a></span>
<span id="cb71-14"><a href="optimal-individualized-treatment-regimes.html#cb71-14"></a><span class="op">$</span>Y</span>
<span id="cb71-15"><a href="optimal-individualized-treatment-regimes.html#cb71-15"></a>[<span class="dv">1</span>] <span class="st">"Y"</span></span></code></pre></div>
<ul>
<li>We now have an observed data structure (<code>data</code>), and a specification of the role
that each variable in the data set plays as the nodes in a DAG.</li>
</ul>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="constructing-stacked-regressions-with-sl3" class="section level4">
<h4>
<span class="header-section-number">5.5.1.2</span> Constructing Stacked Regressions with <code>sl3</code><a class="anchor" aria-label="anchor" href="#constructing-stacked-regressions-with-sl3"><i class="fas fa-link"></i></a>
</h4>
<p>We generate three different ensemble learners that must be fit.</p>
<ol style="list-style-type: decimal">
<li><p>learners for the outcome regression,</p></li>
<li><p>propensity score, and</p></li>
<li><p>blip function.</p></li>
</ol>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define sl3 library and metalearners:</span>
<span class="va">lrn_mean</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_mean.html">Lrnr_mean</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">lrn_glm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm_fast.html">Lrnr_glm_fast</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">lrn_lasso</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">lrnr_hal</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_hal9001.html">Lrnr_hal9001</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>reduce_basis <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Define the Q learner:</span>
<span class="va">Q_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_lasso</span>, <span class="va">lrn_mean</span>, <span class="va">lrn_glm</span><span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="co">## Define the g learner:</span>
<span class="va">g_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_lasso</span>, <span class="va">lrn_glm</span><span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="co">## Define the B learner:</span>
<span class="va">b_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_mean</span>, <span class="va">lrn_glm</span>, <span class="va">lrn_lasso</span><span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>We make the above explicit with respect to standard
notation by bundling the ensemble learners into a list object below:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="optimal-individualized-treatment-regimes.html#cb73-1"></a><span class="co"># specify outcome and treatment regressions and create learner list</span></span>
<span id="cb73-2"><a href="optimal-individualized-treatment-regimes.html#cb73-2"></a>learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner, <span class="dt">B =</span> b_learner)</span>
<span id="cb73-3"><a href="optimal-individualized-treatment-regimes.html#cb73-3"></a>learner_list</span>
<span id="cb73-4"><a href="optimal-individualized-treatment-regimes.html#cb73-4"></a><span class="op">$</span>Y</span>
<span id="cb73-5"><a href="optimal-individualized-treatment-regimes.html#cb73-5"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb73-6"><a href="optimal-individualized-treatment-regimes.html#cb73-6"></a>List of <span class="dv">3</span></span>
<span id="cb73-7"><a href="optimal-individualized-treatment-regimes.html#cb73-7"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glmnet_NULL_deviance_10_1_100_TRUE"</span></span>
<span id="cb73-8"><a href="optimal-individualized-treatment-regimes.html#cb73-8"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_mean"</span></span>
<span id="cb73-9"><a href="optimal-individualized-treatment-regimes.html#cb73-9"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glm_fast_TRUE_Cholesky"</span></span>
<span id="cb73-10"><a href="optimal-individualized-treatment-regimes.html#cb73-10"></a></span>
<span id="cb73-11"><a href="optimal-individualized-treatment-regimes.html#cb73-11"></a><span class="op">$</span>A</span>
<span id="cb73-12"><a href="optimal-individualized-treatment-regimes.html#cb73-12"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb73-13"><a href="optimal-individualized-treatment-regimes.html#cb73-13"></a>List of <span class="dv">2</span></span>
<span id="cb73-14"><a href="optimal-individualized-treatment-regimes.html#cb73-14"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glmnet_NULL_deviance_10_1_100_TRUE"</span></span>
<span id="cb73-15"><a href="optimal-individualized-treatment-regimes.html#cb73-15"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glm_fast_TRUE_Cholesky"</span></span>
<span id="cb73-16"><a href="optimal-individualized-treatment-regimes.html#cb73-16"></a></span>
<span id="cb73-17"><a href="optimal-individualized-treatment-regimes.html#cb73-17"></a><span class="op">$</span>B</span>
<span id="cb73-18"><a href="optimal-individualized-treatment-regimes.html#cb73-18"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb73-19"><a href="optimal-individualized-treatment-regimes.html#cb73-19"></a>List of <span class="dv">3</span></span>
<span id="cb73-20"><a href="optimal-individualized-treatment-regimes.html#cb73-20"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_mean"</span></span>
<span id="cb73-21"><a href="optimal-individualized-treatment-regimes.html#cb73-21"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glm_fast_TRUE_Cholesky"</span></span>
<span id="cb73-22"><a href="optimal-individualized-treatment-regimes.html#cb73-22"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glmnet_NULL_deviance_10_1_100_TRUE"</span></span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="targeted-estimation" class="section level4">
<h4>
<span class="header-section-number">5.5.1.3</span> Targeted Estimation<a class="anchor" aria-label="anchor" href="#targeted-estimation"><i class="fas fa-link"></i></a>
</h4>
<p>To start, we will initialize a specification for the TMLE of our parameter of
interest simply by calling <code>tmle3_mopttx_blip_revere</code>.</p>
<ul>
<li><p>We specify the argument <code>V = c("W1", "W2", "W3")</code> in order to communicate that
we’re interested in learning a rule dependent on <code>V</code> covariates.</p></li>
<li><p>We also need to specify the type of blip we will use in this estimation problem, and
the list of learners used.</p></li>
<li><p>In addition, we need to specify whether we want to maximize or minimize the
mean outcome under the rule (<code>maximize=TRUE</code>).</p></li>
</ul>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip1"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>, resource <span class="op">=</span> <span class="fl">1</span>,
  interpret <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="optimal-individualized-treatment-regimes.html#cb76-1"></a><span class="co"># see the result</span></span>
<span id="cb76-2"><a href="optimal-individualized-treatment-regimes.html#cb76-2"></a>fit</span>
<span id="cb76-3"><a href="optimal-individualized-treatment-regimes.html#cb76-3"></a>A tmle3_Fit that took <span class="dv">1</span> <span class="kw">step</span>(s)</span>
<span id="cb76-4"><a href="optimal-individualized-treatment-regimes.html#cb76-4"></a>   type         param init_est tmle_est       se   lower   upper</span>
<span id="cb76-5"><a href="optimal-individualized-treatment-regimes.html#cb76-5"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span>TSM E[Y_{A=<span class="ot">NULL</span>}]  <span class="fl">0.35585</span>  <span class="fl">0.55755</span> <span class="fl">0.025566</span> <span class="fl">0.50744</span> <span class="fl">0.60765</span></span>
<span id="cb76-6"><a href="optimal-individualized-treatment-regimes.html#cb76-6"></a>   psi_transformed lower_transformed upper_transformed</span>
<span id="cb76-7"><a href="optimal-individualized-treatment-regimes.html#cb76-7"></a><span class="dv">1</span><span class="op">:</span><span class="st">         </span><span class="fl">0.55755</span>           <span class="fl">0.50744</span>           <span class="fl">0.60765</span></span></code></pre></div>
<p><br></p>
<div align="center">
We can see that the confidence interval covers the truth!
</div>
<p><br></p>
<hr>
<p><br></p>
<p>We can also get the interpretable surrogate rule in terms of HAL:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="optimal-individualized-treatment-regimes.html#cb77-1"></a><span class="co"># Interpretable rule</span></span>
<span id="cb77-2"><a href="optimal-individualized-treatment-regimes.html#cb77-2"></a><span class="kw">head</span>(tmle_spec<span class="op">$</span>blip_fit_interpret<span class="op">$</span>coef)</span>
<span id="cb77-3"><a href="optimal-individualized-treatment-regimes.html#cb77-3"></a>[<span class="dv">1</span>]  <span class="fl">0.368043</span>  <span class="fl">0.156435</span> <span class="fl">-0.064386</span> <span class="fl">-0.054062</span>  <span class="fl">0.042386</span>  <span class="fl">0.037879</span></span></code></pre></div>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="optimal-individualized-treatment-regimes.html#cb78-1"></a><span class="co"># Interpretable rule</span></span>
<span id="cb78-2"><a href="optimal-individualized-treatment-regimes.html#cb78-2"></a><span class="kw">head</span>(tmle_spec<span class="op">$</span>blip_fit_interpret<span class="op">$</span>term)</span>
<span id="cb78-3"><a href="optimal-individualized-treatment-regimes.html#cb78-3"></a>[<span class="dv">1</span>] <span class="st">"(Intercept)"</span>                                                                                                  </span>
<span id="cb78-4"><a href="optimal-individualized-treatment-regimes.html#cb78-4"></a>[<span class="dv">2</span>] <span class="st">"[ I(W1 &gt;= 0.899)*(W1 - 0.899)^1 ] * [ I(W2 &gt;= -3.861)*(W2 - -3.861)^1 ]"</span>                                      </span>
<span id="cb78-5"><a href="optimal-individualized-treatment-regimes.html#cb78-5"></a>[<span class="dv">3</span>] <span class="st">"[ I(W1 &gt;= 0.074)*(W1 - 0.074)^1 ] * [ I(W2 &gt;= -3.861)*(W2 - -3.861)^1 ] * [ I(W3 &gt;= -2.945)*(W3 - -2.945)^1 ]"</span></span>
<span id="cb78-6"><a href="optimal-individualized-treatment-regimes.html#cb78-6"></a>[<span class="dv">4</span>] <span class="st">"[ I(W1 &gt;= -1.418)*(W1 - -1.418)^1 ] * [ I(W2 &gt;= -3.861)*(W2 - -3.861)^1 ]"</span>                                    </span>
<span id="cb78-7"><a href="optimal-individualized-treatment-regimes.html#cb78-7"></a>[<span class="dv">5</span>] <span class="st">"[ I(W1 &gt;= 0.856)*(W1 - 0.856)^1 ] * [ I(W2 &gt;= -3.861)*(W2 - -3.861)^1 ] * [ I(W3 &gt;= -1.292)*(W3 - -1.292)^1 ]"</span></span>
<span id="cb78-8"><a href="optimal-individualized-treatment-regimes.html#cb78-8"></a>[<span class="dv">6</span>] <span class="st">"[ I(W1 &gt;= -1.368)*(W1 - -1.368)^1 ] * [ I(W2 &gt;= -3.861)*(W2 - -3.861)^1 ] * [ I(W3 &gt;= 0.843)*(W3 - 0.843)^1 ]"</span></span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="resource-constraint" class="section level4">
<h4>
<span class="header-section-number">5.5.1.4</span> Resource constraint<a class="anchor" aria-label="anchor" href="#resource-constraint"><i class="fas fa-link"></i></a>
</h4>
<p>We can also restrict the number of individuals that get the treatment, even if giving
treatment is beneficial (according to the estimated blip).</p>
<ul>
<li><p>In order to impose a resource constraint, we have to specify the percent
of individuals that will
benefit the most from getting treatment.</p></li>
<li><p>For example, if <code>resource=1</code>, all
individuals with blip higher than zero will get treatment.</p></li>
<li><p>If <code>resource=0</code>, none will get treatment.</p></li>
</ul>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec_resource</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip1"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>, resource <span class="op">=</span> <span class="fl">0.80</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit_resource</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec_resource</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="optimal-individualized-treatment-regimes.html#cb81-1"></a><span class="co"># see the result</span></span>
<span id="cb81-2"><a href="optimal-individualized-treatment-regimes.html#cb81-2"></a>fit_resource</span>
<span id="cb81-3"><a href="optimal-individualized-treatment-regimes.html#cb81-3"></a>A tmle3_Fit that took <span class="dv">1</span> <span class="kw">step</span>(s)</span>
<span id="cb81-4"><a href="optimal-individualized-treatment-regimes.html#cb81-4"></a>   type         param init_est tmle_est       se   lower   upper</span>
<span id="cb81-5"><a href="optimal-individualized-treatment-regimes.html#cb81-5"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span>TSM E[Y_{A=<span class="ot">NULL</span>}]  <span class="fl">0.32947</span>  <span class="fl">0.53611</span> <span class="fl">0.025833</span> <span class="fl">0.48548</span> <span class="fl">0.58674</span></span>
<span id="cb81-6"><a href="optimal-individualized-treatment-regimes.html#cb81-6"></a>   psi_transformed lower_transformed upper_transformed</span>
<span id="cb81-7"><a href="optimal-individualized-treatment-regimes.html#cb81-7"></a><span class="dv">1</span><span class="op">:</span><span class="st">         </span><span class="fl">0.53611</span>           <span class="fl">0.48548</span>           <span class="fl">0.58674</span></span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
<p>We can compare the number of individuals that got treatment with and without the
resource constraint:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="optimal-individualized-treatment-regimes.html#cb82-1"></a><span class="co"># Number of individuals with A=1 (no resource constraint):</span></span>
<span id="cb82-2"><a href="optimal-individualized-treatment-regimes.html#cb82-2"></a><span class="kw">table</span>(tmle_spec<span class="op">$</span>return_rule)</span>
<span id="cb82-3"><a href="optimal-individualized-treatment-regimes.html#cb82-3"></a></span>
<span id="cb82-4"><a href="optimal-individualized-treatment-regimes.html#cb82-4"></a>  <span class="dv">0</span>   <span class="dv">1</span> </span>
<span id="cb82-5"><a href="optimal-individualized-treatment-regimes.html#cb82-5"></a><span class="dv">280</span> <span class="dv">720</span> </span>
<span id="cb82-6"><a href="optimal-individualized-treatment-regimes.html#cb82-6"></a></span>
<span id="cb82-7"><a href="optimal-individualized-treatment-regimes.html#cb82-7"></a><span class="co"># Number of individuals with A=1 (resource constraint):</span></span>
<span id="cb82-8"><a href="optimal-individualized-treatment-regimes.html#cb82-8"></a><span class="kw">table</span>(tmle_spec_resource<span class="op">$</span>return_rule)</span>
<span id="cb82-9"><a href="optimal-individualized-treatment-regimes.html#cb82-9"></a></span>
<span id="cb82-10"><a href="optimal-individualized-treatment-regimes.html#cb82-10"></a>  <span class="dv">0</span>   <span class="dv">1</span> </span>
<span id="cb82-11"><a href="optimal-individualized-treatment-regimes.html#cb82-11"></a><span class="dv">422</span> <span class="dv">578</span> </span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="empty-v" class="section level4">
<h4>
<span class="header-section-number">5.5.1.5</span> Empty V<a class="anchor" aria-label="anchor" href="#empty-v"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec_V_empty</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  type <span class="op">=</span> <span class="st">"blip1"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>, resource <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit_V_empty</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec_V_empty</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="optimal-individualized-treatment-regimes.html#cb85-1"></a><span class="co"># see the result:</span></span>
<span id="cb85-2"><a href="optimal-individualized-treatment-regimes.html#cb85-2"></a>fit_V_empty</span>
<span id="cb85-3"><a href="optimal-individualized-treatment-regimes.html#cb85-3"></a>A tmle3_Fit that took <span class="dv">1</span> <span class="kw">step</span>(s)</span>
<span id="cb85-4"><a href="optimal-individualized-treatment-regimes.html#cb85-4"></a>   type         param init_est tmle_est     se   lower   upper psi_transformed</span>
<span id="cb85-5"><a href="optimal-individualized-treatment-regimes.html#cb85-5"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span>TSM E[Y_{A=<span class="ot">NULL</span>}]  <span class="fl">0.32699</span>  <span class="fl">0.53301</span> <span class="fl">0.0104</span> <span class="fl">0.51263</span> <span class="fl">0.55339</span>         <span class="fl">0.53301</span></span>
<span id="cb85-6"><a href="optimal-individualized-treatment-regimes.html#cb85-6"></a>   lower_transformed upper_transformed</span>
<span id="cb85-7"><a href="optimal-individualized-treatment-regimes.html#cb85-7"></a><span class="dv">1</span><span class="op">:</span><span class="st">           </span><span class="fl">0.51263</span>           <span class="fl">0.55339</span></span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
</div>
</div>
</div>
<div id="categorical-treatment" class="section level2">
<h2>
<span class="header-section-number">5.6</span> Categorical Treatment<a class="anchor" aria-label="anchor" href="#categorical-treatment"><i class="fas fa-link"></i></a>
</h2>
<div align="center">
<strong>QUESTION:</strong> What if the treatment is categorical, with more than two categories?
Can we still use the blip function?
</div>
<p><br></p>
<ul>
<li><p>We define <strong>pseudo-blips</strong>: vector valued entities where the output for a given
<span class="math inline">\(V\)</span> is a vector of length equal to the number of treatment categories, <span class="math inline">\(n_A\)</span>.</p></li>
<li><p>As such, we define it as:
<span class="math display">\[\bar{Q}_0^{pblip}(V) = \{\bar{Q}_{0,a}^{pblip}(V): a \in \mathcal{A} \}.\]</span></p></li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<p>We implement three different pseudo-blips in <code>tmle3mopttx</code>.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Blip1</strong> corresponds to choosing a reference category of treatment, and
defining the blip for all other categories relative to the specified reference:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-ref}(V) \equiv E_0(Y_a-Y_0|V)\]</span>
<br></p></li>
<li><p><strong>Blip2</strong> corresponds to defining the blip relative to the average of
all categories:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-avg}(V) \equiv E_0(Y_a- \frac{1}{n_A} \sum_{a \in \mathcal{A}} Y_a|V)\]</span>
<br></p></li>
<li><p><strong>Blip3</strong> reflects an extension of Blip2, where the average is now a weighted average:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-wavg}(V) \equiv E_0(Y_a- \frac{1}{n_A} \sum_{a \in \mathcal{A}} Y_{a} P(A=a|V)
|V)\]</span></p></li>
</ol>
<p><br></p>
<hr>
<p><br></p>
<div id="causal-effect-of-oit-with-categorical-a" class="section level3">
<h3>
<span class="header-section-number">5.6.1</span> Causal Effect of OIT with Categorical A<a class="anchor" aria-label="anchor" href="#causal-effect-of-oit-with-categorical-a"><i class="fas fa-link"></i></a>
</h3>
<p>We now need to pay attention to the <strong>type of blip</strong> we define in the estimation stage,
as well as <strong>how we construct our learners.</strong></p>
<div id="simulated-data" class="section level4">
<h4>
<span class="header-section-number">5.6.1.1</span> Simulated Data<a class="anchor" aria-label="anchor" href="#simulated-data"><i class="fas fa-link"></i></a>
</h4>
<p>First, we load the simulated data. Here, our data generating distribution was
of the following form:</p>
<p><br></p>
<p><span class="math display">\[W \sim \mathcal{N}(\bf{0},I_{4 \times 4})\]</span>
<span class="math display">\[P(A|W) = \frac{1}{1+\exp^{(-(0.05*I(A=1)*W_1+0.8*I(A=2)*W_1+0.8*I(A=3)*W_1))}}\]</span></p>
<p><span class="math display">\[P(Y|A,W)=0.5\text{logit}^{-1}[15I(A=1)(W_1-0.5) - 3I(A=2)(2W_1+0.5) \\
+ 3I(A=3)(3W_1-0.5)] +\text{logit}^{-1}(W_2W_1)\]</span></p>
<p><br></p>
<hr>
<p><br></p>
<p>We can just load the data available as part of the package as follows:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="optimal-individualized-treatment-regimes.html#cb86-1"></a><span class="kw">head</span>(data)</span>
<span id="cb86-2"><a href="optimal-individualized-treatment-regimes.html#cb86-2"></a>   W1       W2       W3       W4 A Y</span>
<span id="cb86-3"><a href="optimal-individualized-treatment-regimes.html#cb86-3"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span> <span class="fl">-0.40168</span>  <span class="fl">0.15008</span>  <span class="fl">1.44274</span> <span class="dv">2</span> <span class="dv">1</span></span>
<span id="cb86-4"><a href="optimal-individualized-treatment-regimes.html#cb86-4"></a><span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span> <span class="fl">-0.37093</span>  <span class="fl">0.79472</span>  <span class="fl">1.08879</span> <span class="dv">3</span> <span class="dv">0</span></span>
<span id="cb86-5"><a href="optimal-individualized-treatment-regimes.html#cb86-5"></a><span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span> <span class="fl">-0.42515</span>  <span class="fl">0.43203</span>  <span class="fl">0.22471</span> <span class="dv">2</span> <span class="dv">1</span></span>
<span id="cb86-6"><a href="optimal-individualized-treatment-regimes.html#cb86-6"></a><span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="fl">0.44115</span>  <span class="fl">0.34370</span>  <span class="fl">1.55538</span> <span class="dv">3</span> <span class="dv">0</span></span>
<span id="cb86-7"><a href="optimal-individualized-treatment-regimes.html#cb86-7"></a><span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span> <span class="fl">-0.67275</span>  <span class="fl">0.38710</span> <span class="fl">-0.31411</span> <span class="dv">2</span> <span class="dv">0</span></span>
<span id="cb86-8"><a href="optimal-individualized-treatment-regimes.html#cb86-8"></a><span class="dv">6</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="fl">0.41669</span> <span class="fl">-0.78808</span> <span class="fl">-0.28718</span> <span class="dv">2</span> <span class="dv">1</span></span></code></pre></div>
<ul>
<li><p>The above constructs our observed data structure <span class="math inline">\(O = (W, A, Y)\)</span>.</p></li>
<li><p>The true mean under the OIT is <span class="math inline">\(\psi=0.658\)</span>, which is the quantity we aim
to estimate.</p></li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="optimal-individualized-treatment-regimes.html#cb87-1"></a><span class="co"># organize data and nodes for tmle3</span></span>
<span id="cb87-2"><a href="optimal-individualized-treatment-regimes.html#cb87-2"></a>data &lt;-<span class="st"> </span>data_cat_realistic</span>
<span id="cb87-3"><a href="optimal-individualized-treatment-regimes.html#cb87-3"></a>node_list &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb87-4"><a href="optimal-individualized-treatment-regimes.html#cb87-4"></a>  <span class="dt">W =</span> <span class="kw">c</span>(<span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span>, <span class="st">"W4"</span>),</span>
<span id="cb87-5"><a href="optimal-individualized-treatment-regimes.html#cb87-5"></a>  <span class="dt">A =</span> <span class="st">"A"</span>,</span>
<span id="cb87-6"><a href="optimal-individualized-treatment-regimes.html#cb87-6"></a>  <span class="dt">Y =</span> <span class="st">"Y"</span></span>
<span id="cb87-7"><a href="optimal-individualized-treatment-regimes.html#cb87-7"></a>)</span>
<span id="cb87-8"><a href="optimal-individualized-treatment-regimes.html#cb87-8"></a>node_list</span>
<span id="cb87-9"><a href="optimal-individualized-treatment-regimes.html#cb87-9"></a><span class="op">$</span>W</span>
<span id="cb87-10"><a href="optimal-individualized-treatment-regimes.html#cb87-10"></a>[<span class="dv">1</span>] <span class="st">"W1"</span> <span class="st">"W2"</span> <span class="st">"W3"</span> <span class="st">"W4"</span></span>
<span id="cb87-11"><a href="optimal-individualized-treatment-regimes.html#cb87-11"></a></span>
<span id="cb87-12"><a href="optimal-individualized-treatment-regimes.html#cb87-12"></a><span class="op">$</span>A</span>
<span id="cb87-13"><a href="optimal-individualized-treatment-regimes.html#cb87-13"></a>[<span class="dv">1</span>] <span class="st">"A"</span></span>
<span id="cb87-14"><a href="optimal-individualized-treatment-regimes.html#cb87-14"></a></span>
<span id="cb87-15"><a href="optimal-individualized-treatment-regimes.html#cb87-15"></a><span class="op">$</span>Y</span>
<span id="cb87-16"><a href="optimal-individualized-treatment-regimes.html#cb87-16"></a>[<span class="dv">1</span>] <span class="st">"Y"</span></span></code></pre></div>
<p>We can see the number of observed categories of treatment below:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="optimal-individualized-treatment-regimes.html#cb88-1"></a><span class="co"># organize data and nodes for tmle3</span></span>
<span id="cb88-2"><a href="optimal-individualized-treatment-regimes.html#cb88-2"></a><span class="kw">table</span>(data<span class="op">$</span>A)</span>
<span id="cb88-3"><a href="optimal-individualized-treatment-regimes.html#cb88-3"></a></span>
<span id="cb88-4"><a href="optimal-individualized-treatment-regimes.html#cb88-4"></a>  <span class="dv">1</span>   <span class="dv">2</span>   <span class="dv">3</span> </span>
<span id="cb88-5"><a href="optimal-individualized-treatment-regimes.html#cb88-5"></a> <span class="dv">24</span> <span class="dv">528</span> <span class="dv">448</span> </span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="constructing-stacked-regressions-with-sl3-1" class="section level4">
<h4>
<span class="header-section-number">5.6.1.2</span> Constructing Stacked Regressions with <code>sl3</code><a class="anchor" aria-label="anchor" href="#constructing-stacked-regressions-with-sl3-1"><i class="fas fa-link"></i></a>
</h4>
<p><strong>QUESTION:</strong> With categorical treatment, what is the dimension of the blip now?
What is the dimension for the current example? How would we go about estimating it?</p>
<p><br></p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Initialize few of the learners:</span>
<span class="va">lrn_xgboost_50</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">lrn_mean</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_mean.html">Lrnr_mean</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">lrn_glm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm_fast.html">Lrnr_glm_fast</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>

<span class="co">## Define the Q learner, which is just a regular learner:</span>
<span class="va">Q_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_xgboost_50</span>, <span class="va">lrn_mean</span>, <span class="va">lrn_glm</span><span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="co">## Define the g learner, which is a multinomial learner:</span>
<span class="co"># specify the appropriate loss of the multinomial learner:</span>
<span class="va">mn_metalearner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Lrnr_solnp</span>,
  eval_function <span class="op">=</span> <span class="va">loss_loglik_multinomial</span>,
  learner_function <span class="op">=</span> <span class="va">metalearner_linear_multinomial</span>
<span class="op">)</span>
<span class="va">g_learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Lrnr_sl</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_xgboost_50</span>, <span class="va">lrn_mean</span><span class="op">)</span>, <span class="va">mn_metalearner</span><span class="op">)</span>

<span class="co">## Define the Blip learner, which is a multivariate learner:</span>
<span class="va">learners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_xgboost_50</span>, <span class="va">lrn_mean</span>, <span class="va">lrn_glm</span><span class="op">)</span>
<span class="va">b_learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/create_mv_learners.html">create_mv_learners</a></span><span class="op">(</span>learners <span class="op">=</span> <span class="va">learners</span><span class="op">)</span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
<ul>
<li><p>We need to estimate <span class="math inline">\(g_0(A|W)\)</span> for a categorical <span class="math inline">\(A\)</span>:
we use the <strong>multinomial</strong> Super Learner option available within the <code>sl3</code> package.</p></li>
<li><p>We need to estimate the blip using a <strong>multivariate</strong> Super Learner
available within the <code>sl3</code> package.</p></li>
</ul>
<p><br></p>
<p>In order to see which learners can
be used to estimate <span class="math inline">\(g_0(A|W)\)</span> in <code>sl3</code>, we run the following:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="optimal-individualized-treatment-regimes.html#cb90-1"></a><span class="co"># See which learners support multi-class classification:</span></span>
<span id="cb90-2"><a href="optimal-individualized-treatment-regimes.html#cb90-2"></a><span class="kw">sl3_list_learners</span>(<span class="kw">c</span>(<span class="st">"categorical"</span>))</span>
<span id="cb90-3"><a href="optimal-individualized-treatment-regimes.html#cb90-3"></a> [<span class="dv">1</span>] <span class="st">"Lrnr_bound"</span>                <span class="st">"Lrnr_caret"</span>               </span>
<span id="cb90-4"><a href="optimal-individualized-treatment-regimes.html#cb90-4"></a> [<span class="dv">3</span>] <span class="st">"Lrnr_cv_selector"</span>          <span class="st">"Lrnr_ga"</span>                  </span>
<span id="cb90-5"><a href="optimal-individualized-treatment-regimes.html#cb90-5"></a> [<span class="dv">5</span>] <span class="st">"Lrnr_glmnet"</span>               <span class="st">"Lrnr_grf"</span>                 </span>
<span id="cb90-6"><a href="optimal-individualized-treatment-regimes.html#cb90-6"></a> [<span class="dv">7</span>] <span class="st">"Lrnr_gru_keras"</span>            <span class="st">"Lrnr_h2o_glm"</span>             </span>
<span id="cb90-7"><a href="optimal-individualized-treatment-regimes.html#cb90-7"></a> [<span class="dv">9</span>] <span class="st">"Lrnr_h2o_grid"</span>             <span class="st">"Lrnr_independent_binomial"</span></span>
<span id="cb90-8"><a href="optimal-individualized-treatment-regimes.html#cb90-8"></a>[<span class="dv">11</span>] <span class="st">"Lrnr_lightgbm"</span>             <span class="st">"Lrnr_lstm_keras"</span>          </span>
<span id="cb90-9"><a href="optimal-individualized-treatment-regimes.html#cb90-9"></a>[<span class="dv">13</span>] <span class="st">"Lrnr_mean"</span>                 <span class="st">"Lrnr_multivariate"</span>        </span>
<span id="cb90-10"><a href="optimal-individualized-treatment-regimes.html#cb90-10"></a>[<span class="dv">15</span>] <span class="st">"Lrnr_nnet"</span>                 <span class="st">"Lrnr_optim"</span>               </span>
<span id="cb90-11"><a href="optimal-individualized-treatment-regimes.html#cb90-11"></a>[<span class="dv">17</span>] <span class="st">"Lrnr_polspline"</span>            <span class="st">"Lrnr_pooled_hazards"</span>      </span>
<span id="cb90-12"><a href="optimal-individualized-treatment-regimes.html#cb90-12"></a>[<span class="dv">19</span>] <span class="st">"Lrnr_randomForest"</span>         <span class="st">"Lrnr_ranger"</span>              </span>
<span id="cb90-13"><a href="optimal-individualized-treatment-regimes.html#cb90-13"></a>[<span class="dv">21</span>] <span class="st">"Lrnr_rpart"</span>                <span class="st">"Lrnr_screener_correlation"</span></span>
<span id="cb90-14"><a href="optimal-individualized-treatment-regimes.html#cb90-14"></a>[<span class="dv">23</span>] <span class="st">"Lrnr_solnp"</span>                <span class="st">"Lrnr_svm"</span>                 </span>
<span id="cb90-15"><a href="optimal-individualized-treatment-regimes.html#cb90-15"></a>[<span class="dv">25</span>] <span class="st">"Lrnr_xgboost"</span>             </span></code></pre></div>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="optimal-individualized-treatment-regimes.html#cb91-1"></a><span class="co"># specify outcome and treatment regressions and create learner list</span></span>
<span id="cb91-2"><a href="optimal-individualized-treatment-regimes.html#cb91-2"></a>learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner, <span class="dt">B =</span> b_learner)</span>
<span id="cb91-3"><a href="optimal-individualized-treatment-regimes.html#cb91-3"></a>learner_list</span>
<span id="cb91-4"><a href="optimal-individualized-treatment-regimes.html#cb91-4"></a><span class="op">$</span>Y</span>
<span id="cb91-5"><a href="optimal-individualized-treatment-regimes.html#cb91-5"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb91-6"><a href="optimal-individualized-treatment-regimes.html#cb91-6"></a>List of <span class="dv">3</span></span>
<span id="cb91-7"><a href="optimal-individualized-treatment-regimes.html#cb91-7"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_xgboost_50_1"</span></span>
<span id="cb91-8"><a href="optimal-individualized-treatment-regimes.html#cb91-8"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_mean"</span></span>
<span id="cb91-9"><a href="optimal-individualized-treatment-regimes.html#cb91-9"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glm_fast_TRUE_Cholesky"</span></span>
<span id="cb91-10"><a href="optimal-individualized-treatment-regimes.html#cb91-10"></a></span>
<span id="cb91-11"><a href="optimal-individualized-treatment-regimes.html#cb91-11"></a><span class="op">$</span>A</span>
<span id="cb91-12"><a href="optimal-individualized-treatment-regimes.html#cb91-12"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb91-13"><a href="optimal-individualized-treatment-regimes.html#cb91-13"></a>List of <span class="dv">2</span></span>
<span id="cb91-14"><a href="optimal-individualized-treatment-regimes.html#cb91-14"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_xgboost_50_1"</span></span>
<span id="cb91-15"><a href="optimal-individualized-treatment-regimes.html#cb91-15"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_mean"</span></span>
<span id="cb91-16"><a href="optimal-individualized-treatment-regimes.html#cb91-16"></a></span>
<span id="cb91-17"><a href="optimal-individualized-treatment-regimes.html#cb91-17"></a><span class="op">$</span>B</span>
<span id="cb91-18"><a href="optimal-individualized-treatment-regimes.html#cb91-18"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb91-19"><a href="optimal-individualized-treatment-regimes.html#cb91-19"></a>List of <span class="dv">3</span></span>
<span id="cb91-20"><a href="optimal-individualized-treatment-regimes.html#cb91-20"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_xgboost_50_1_multivariate"</span></span>
<span id="cb91-21"><a href="optimal-individualized-treatment-regimes.html#cb91-21"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_mean_multivariate"</span></span>
<span id="cb91-22"><a href="optimal-individualized-treatment-regimes.html#cb91-22"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glm_fast_TRUE_Cholesky_multivariate"</span></span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="targeted-estimation-1" class="section level4">
<h4>
<span class="header-section-number">5.6.1.3</span> Targeted Estimation<a class="anchor" aria-label="anchor" href="#targeted-estimation-1"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span>, <span class="st">"W4"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>, maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec_cat</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="optimal-individualized-treatment-regimes.html#cb94-1"></a><span class="co"># see the result:</span></span>
<span id="cb94-2"><a href="optimal-individualized-treatment-regimes.html#cb94-2"></a>fit_cat</span>
<span id="cb94-3"><a href="optimal-individualized-treatment-regimes.html#cb94-3"></a>A tmle3_Fit that took <span class="dv">1</span> <span class="kw">step</span>(s)</span>
<span id="cb94-4"><a href="optimal-individualized-treatment-regimes.html#cb94-4"></a>   type         param init_est tmle_est       se   lower   upper</span>
<span id="cb94-5"><a href="optimal-individualized-treatment-regimes.html#cb94-5"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span>TSM E[Y_{A=<span class="ot">NULL</span>}]  <span class="fl">0.54334</span>  <span class="fl">0.61973</span> <span class="fl">0.063746</span> <span class="fl">0.49479</span> <span class="fl">0.74467</span></span>
<span id="cb94-6"><a href="optimal-individualized-treatment-regimes.html#cb94-6"></a>   psi_transformed lower_transformed upper_transformed</span>
<span id="cb94-7"><a href="optimal-individualized-treatment-regimes.html#cb94-7"></a><span class="dv">1</span><span class="op">:</span><span class="st">         </span><span class="fl">0.61973</span>           <span class="fl">0.49479</span>           <span class="fl">0.74467</span></span>
<span id="cb94-8"><a href="optimal-individualized-treatment-regimes.html#cb94-8"></a></span>
<span id="cb94-9"><a href="optimal-individualized-treatment-regimes.html#cb94-9"></a><span class="co"># How many individuals got assigned each treatment?</span></span>
<span id="cb94-10"><a href="optimal-individualized-treatment-regimes.html#cb94-10"></a><span class="kw">table</span>(tmle_spec_cat<span class="op">$</span>return_rule)</span>
<span id="cb94-11"><a href="optimal-individualized-treatment-regimes.html#cb94-11"></a></span>
<span id="cb94-12"><a href="optimal-individualized-treatment-regimes.html#cb94-12"></a>  <span class="dv">1</span>   <span class="dv">2</span>   <span class="dv">3</span> </span>
<span id="cb94-13"><a href="optimal-individualized-treatment-regimes.html#cb94-13"></a><span class="dv">438</span> <span class="dv">380</span> <span class="dv">182</span> </span></code></pre></div>
<p>We can see that the confidence interval covers the truth.</p>
<p><br></p>
<div align="center">
<strong>NOTICE the distribution of the assigned treatment! We will need this shortly.</strong>
</div>
<p><br></p>
<hr>
<p><br></p>
</div>
</div>
</div>
<div id="extensions" class="section level2">
<h2>
<span class="header-section-number">5.7</span> Extensions<a class="anchor" aria-label="anchor" href="#extensions"><i class="fas fa-link"></i></a>
</h2>
<p>We consider multiple extensions to the procedure described for
estimating the value of the ITR.</p>
<p><br></p>
<ul>
<li>One might be interested in a grid of possible suboptimal rules, corresponding to
potentially limited knowledge of potential effect modifiers (<strong>Simpler Rules</strong>).</li>
</ul>
<p><br></p>
<ul>
<li>Certain regimes might be preferred, but due to positivity restraints are not realistic to implement (<strong>Realistic Interventions</strong>).</li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<div id="simpler-rules" class="section level3">
<h3>
<span class="header-section-number">5.7.1</span> Simpler Rules<a class="anchor" aria-label="anchor" href="#simpler-rules"><i class="fas fa-link"></i></a>
</h3>
<p>We define <span class="math inline">\(S\)</span>-optimal rules as the optimal rule that considers all possible subsets
of <span class="math inline">\(V\)</span> covariates, with card(<span class="math inline">\(S\)</span>) <span class="math inline">\(\leq\)</span> card(<span class="math inline">\(V\)</span>) and <span class="math inline">\(\emptyset \in S\)</span>.</p>
<ul>
<li>This allows us to consider sub-optimal rules that are easier to estimate:
we allow for statistical inference for the counterfactual mean outcome under the sub-optimal rule.</li>
</ul>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec_cat_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W4"</span>, <span class="st">"W3"</span>, <span class="st">"W2"</span>, <span class="st">"W1"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">FALSE</span>, realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit_cat_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec_cat_simple</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="optimal-individualized-treatment-regimes.html#cb97-1"></a><span class="co"># see the result:</span></span>
<span id="cb97-2"><a href="optimal-individualized-treatment-regimes.html#cb97-2"></a>fit_cat_simple</span>
<span id="cb97-3"><a href="optimal-individualized-treatment-regimes.html#cb97-3"></a>A tmle3_Fit that took <span class="dv">1</span> <span class="kw">step</span>(s)</span>
<span id="cb97-4"><a href="optimal-individualized-treatment-regimes.html#cb97-4"></a>   type                param init_est tmle_est      se   lower   upper</span>
<span id="cb97-5"><a href="optimal-individualized-treatment-regimes.html#cb97-5"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span>TSM E[Y_{<span class="kw">d</span>(<span class="dt">V=</span>W3,W2,W1)}]  <span class="fl">0.55423</span>  <span class="fl">0.62196</span> <span class="fl">0.05204</span> <span class="fl">0.51997</span> <span class="fl">0.72396</span></span>
<span id="cb97-6"><a href="optimal-individualized-treatment-regimes.html#cb97-6"></a>   psi_transformed lower_transformed upper_transformed</span>
<span id="cb97-7"><a href="optimal-individualized-treatment-regimes.html#cb97-7"></a><span class="dv">1</span><span class="op">:</span><span class="st">         </span><span class="fl">0.62196</span>           <span class="fl">0.51997</span>           <span class="fl">0.72396</span></span></code></pre></div>
<p><br></p>
<p>Even though the user specified all baseline covariates as the basis
for rule estimation, a simpler rule is sufficient to
maximize the mean under the optimal individualized treatment.</p>
<p><br></p>
<p><strong>QUESTION:</strong> How does the set of covariates picked by <code>tmle3mopttx</code>
compare to the baseline covariates the true rule depends on?</p>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="realistic-optimal-individual-regimes" class="section level3">
<h3>
<span class="header-section-number">5.7.2</span> Realistic Optimal Individual Regimes<a class="anchor" aria-label="anchor" href="#realistic-optimal-individual-regimes"><i class="fas fa-link"></i></a>
</h3>
<p><code>tmle3mopttx</code> also provides an option to estimate the mean under the
realistic, or implementable, optimal individualized treatment.</p>
<ul>
<li><p>It is often the case that assigning particular regime might optimize
the desired outcome, but due to
global or practical positivity constrains, such treatment
can never be implemented (or is highly unlikely).</p></li>
<li><p>Specifying <code>realistic="TRUE"</code>, we consider possibly suboptimal
treatments that optimize the outcome in question while being
supported by the data.</p></li>
</ul>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec_cat_realistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W4"</span>, <span class="st">"W3"</span>, <span class="st">"W2"</span>, <span class="st">"W1"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>, realistic <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit_cat_realistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec_cat_realistic</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="optimal-individualized-treatment-regimes.html#cb100-1"></a><span class="co"># see the result:</span></span>
<span id="cb100-2"><a href="optimal-individualized-treatment-regimes.html#cb100-2"></a>fit_cat_realistic</span>
<span id="cb100-3"><a href="optimal-individualized-treatment-regimes.html#cb100-3"></a>A tmle3_Fit that took <span class="dv">1</span> <span class="kw">step</span>(s)</span>
<span id="cb100-4"><a href="optimal-individualized-treatment-regimes.html#cb100-4"></a>   type         param init_est tmle_est       se  lower   upper psi_transformed</span>
<span id="cb100-5"><a href="optimal-individualized-treatment-regimes.html#cb100-5"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span>TSM E[Y_{A=<span class="ot">NULL</span>}]   <span class="fl">0.5546</span>  <span class="fl">0.57351</span> <span class="fl">0.059035</span> <span class="fl">0.4578</span> <span class="fl">0.68921</span>         <span class="fl">0.57351</span></span>
<span id="cb100-6"><a href="optimal-individualized-treatment-regimes.html#cb100-6"></a>   lower_transformed upper_transformed</span>
<span id="cb100-7"><a href="optimal-individualized-treatment-regimes.html#cb100-7"></a><span class="dv">1</span><span class="op">:</span><span class="st">            </span><span class="fl">0.4578</span>           <span class="fl">0.68921</span></span>
<span id="cb100-8"><a href="optimal-individualized-treatment-regimes.html#cb100-8"></a></span>
<span id="cb100-9"><a href="optimal-individualized-treatment-regimes.html#cb100-9"></a><span class="co"># How many individuals got assigned each treatment?</span></span>
<span id="cb100-10"><a href="optimal-individualized-treatment-regimes.html#cb100-10"></a><span class="kw">table</span>(tmle_spec_cat_realistic<span class="op">$</span>return_rule)</span>
<span id="cb100-11"><a href="optimal-individualized-treatment-regimes.html#cb100-11"></a></span>
<span id="cb100-12"><a href="optimal-individualized-treatment-regimes.html#cb100-12"></a>  <span class="dv">1</span>   <span class="dv">2</span>   <span class="dv">3</span> </span>
<span id="cb100-13"><a href="optimal-individualized-treatment-regimes.html#cb100-13"></a>  <span class="dv">5</span> <span class="dv">511</span> <span class="dv">484</span> </span></code></pre></div>
<p><br></p>
<div align="center">
<strong>QUESTION:</strong> Referring back to the data-generating distribution, why do you
think the distribution of allocated treatment changed from the distribution
we had under the “non-realistic”" rule?
</div>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="missingness-and-tmle3mopttx" class="section level3">
<h3>
<span class="header-section-number">5.7.3</span> Missingness and <code>tmle3mopttx</code><a class="anchor" aria-label="anchor" href="#missingness-and-tmle3mopttx"><i class="fas fa-link"></i></a>
</h3>
<p>In this section, we present how to use the <code>tmle3mopttx</code> package when the data is subject
to missingness. Currently we support missing process on the following nodes:</p>
<ol style="list-style-type: decimal">
<li>outcome node, <span class="math inline">\(Y\)</span>;</li>
</ol>
<p>all other types of missingness are handled by <code>sl3</code> package. Let’s add some missingness to
our outcome.</p>
<p><br></p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_missing</span> <span class="op">&lt;-</span> <span class="va">data_cat_realistic</span>

<span class="co"># Add some random missingless:</span>
<span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_missing</span><span class="op">)</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">data_missing</span><span class="op">[</span><span class="va">rr</span>, <span class="st">"Y"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></code></pre></div>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="optimal-individualized-treatment-regimes.html#cb102-1"></a><span class="co"># look at the data again:</span></span>
<span id="cb102-2"><a href="optimal-individualized-treatment-regimes.html#cb102-2"></a><span class="kw">summary</span>(data_missing<span class="op">$</span>Y)</span>
<span id="cb102-3"><a href="optimal-individualized-treatment-regimes.html#cb102-3"></a>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA<span class="st">'s </span></span>
<span id="cb102-4"><a href="optimal-individualized-treatment-regimes.html#cb102-4"></a><span class="st">   0.00    0.00    0.00    0.47    1.00    1.00     100 </span></span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
<p>To start, we must first add to our library.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="optimal-individualized-treatment-regimes.html#cb103-1"></a>delta_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</span>
<span id="cb103-2"><a href="optimal-individualized-treatment-regimes.html#cb103-2"></a>  <span class="dt">learners =</span> <span class="kw">list</span>(lrn_mean, lrn_glm),</span>
<span id="cb103-3"><a href="optimal-individualized-treatment-regimes.html#cb103-3"></a>  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()</span>
<span id="cb103-4"><a href="optimal-individualized-treatment-regimes.html#cb103-4"></a>)</span>
<span id="cb103-5"><a href="optimal-individualized-treatment-regimes.html#cb103-5"></a></span>
<span id="cb103-6"><a href="optimal-individualized-treatment-regimes.html#cb103-6"></a><span class="co"># specify outcome and treatment regressions and create learner list</span></span>
<span id="cb103-7"><a href="optimal-individualized-treatment-regimes.html#cb103-7"></a>learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner, <span class="dt">B =</span> b_learner, <span class="dt">delta_Y =</span> delta_learner)</span>
<span id="cb103-8"><a href="optimal-individualized-treatment-regimes.html#cb103-8"></a>learner_list</span>
<span id="cb103-9"><a href="optimal-individualized-treatment-regimes.html#cb103-9"></a><span class="op">$</span>Y</span>
<span id="cb103-10"><a href="optimal-individualized-treatment-regimes.html#cb103-10"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb103-11"><a href="optimal-individualized-treatment-regimes.html#cb103-11"></a>List of <span class="dv">3</span></span>
<span id="cb103-12"><a href="optimal-individualized-treatment-regimes.html#cb103-12"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_xgboost_50_1"</span></span>
<span id="cb103-13"><a href="optimal-individualized-treatment-regimes.html#cb103-13"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_mean"</span></span>
<span id="cb103-14"><a href="optimal-individualized-treatment-regimes.html#cb103-14"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glm_fast_TRUE_Cholesky"</span></span>
<span id="cb103-15"><a href="optimal-individualized-treatment-regimes.html#cb103-15"></a></span>
<span id="cb103-16"><a href="optimal-individualized-treatment-regimes.html#cb103-16"></a><span class="op">$</span>A</span>
<span id="cb103-17"><a href="optimal-individualized-treatment-regimes.html#cb103-17"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb103-18"><a href="optimal-individualized-treatment-regimes.html#cb103-18"></a>List of <span class="dv">2</span></span>
<span id="cb103-19"><a href="optimal-individualized-treatment-regimes.html#cb103-19"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_xgboost_50_1"</span></span>
<span id="cb103-20"><a href="optimal-individualized-treatment-regimes.html#cb103-20"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_mean"</span></span>
<span id="cb103-21"><a href="optimal-individualized-treatment-regimes.html#cb103-21"></a></span>
<span id="cb103-22"><a href="optimal-individualized-treatment-regimes.html#cb103-22"></a><span class="op">$</span>B</span>
<span id="cb103-23"><a href="optimal-individualized-treatment-regimes.html#cb103-23"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb103-24"><a href="optimal-individualized-treatment-regimes.html#cb103-24"></a>List of <span class="dv">3</span></span>
<span id="cb103-25"><a href="optimal-individualized-treatment-regimes.html#cb103-25"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_xgboost_50_1_multivariate"</span></span>
<span id="cb103-26"><a href="optimal-individualized-treatment-regimes.html#cb103-26"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_mean_multivariate"</span></span>
<span id="cb103-27"><a href="optimal-individualized-treatment-regimes.html#cb103-27"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glm_fast_TRUE_Cholesky_multivariate"</span></span>
<span id="cb103-28"><a href="optimal-individualized-treatment-regimes.html#cb103-28"></a></span>
<span id="cb103-29"><a href="optimal-individualized-treatment-regimes.html#cb103-29"></a><span class="op">$</span>delta_Y</span>
<span id="cb103-30"><a href="optimal-individualized-treatment-regimes.html#cb103-30"></a>[<span class="dv">1</span>] <span class="st">"Super learner:"</span></span>
<span id="cb103-31"><a href="optimal-individualized-treatment-regimes.html#cb103-31"></a>List of <span class="dv">2</span></span>
<span id="cb103-32"><a href="optimal-individualized-treatment-regimes.html#cb103-32"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_mean"</span></span>
<span id="cb103-33"><a href="optimal-individualized-treatment-regimes.html#cb103-33"></a> <span class="op">$</span><span class="st"> </span><span class="er">:</span><span class="st"> </span>chr <span class="st">"Lrnr_glm_fast_TRUE_Cholesky"</span></span></code></pre></div>
<p>Now <code>delta_Y</code> fits the missing outcome process.</p>
<p><br></p>
<hr>
<p><br></p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec_cat_miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span>, <span class="st">"W4"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>, maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit_cat_miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec_cat_miss</span>, <span class="va">data_missing</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="optimal-individualized-treatment-regimes.html#cb106-1"></a>fit_cat_miss</span>
<span id="cb106-2"><a href="optimal-individualized-treatment-regimes.html#cb106-2"></a>A tmle3_Fit that took <span class="dv">1</span> <span class="kw">step</span>(s)</span>
<span id="cb106-3"><a href="optimal-individualized-treatment-regimes.html#cb106-3"></a>   type                    param init_est tmle_est       se   lower   upper</span>
<span id="cb106-4"><a href="optimal-individualized-treatment-regimes.html#cb106-4"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span>TSM E[Y_{A=<span class="ot">NULL</span>, delta_Y=<span class="dv">1</span>}]  <span class="fl">0.55533</span>  <span class="fl">0.81095</span> <span class="fl">0.017859</span> <span class="fl">0.77595</span> <span class="fl">0.84595</span></span>
<span id="cb106-5"><a href="optimal-individualized-treatment-regimes.html#cb106-5"></a>   psi_transformed lower_transformed upper_transformed</span>
<span id="cb106-6"><a href="optimal-individualized-treatment-regimes.html#cb106-6"></a><span class="dv">1</span><span class="op">:</span><span class="st">         </span><span class="fl">0.81095</span>           <span class="fl">0.77595</span>           <span class="fl">0.84595</span></span></code></pre></div>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="variable-importance-analysis" class="section level3">
<h3>
<span class="header-section-number">5.7.4</span> Variable Importance Analysis<a class="anchor" aria-label="anchor" href="#variable-importance-analysis"><i class="fas fa-link"></i></a>
</h3>
<p>In order to run <code>tmle3mopttx</code> variable importance measure, we
need to considered covariates that are categorical variables.</p>
<ul>
<li>For illustration purpose, we bin baseline covariates corresponding
to the data-generating distribution described in the previous section:</li>
</ul>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="optimal-individualized-treatment-regimes.html#cb107-1"></a><span class="co"># bin baseline covariates to 3 categories:</span></span>
<span id="cb107-2"><a href="optimal-individualized-treatment-regimes.html#cb107-2"></a>data<span class="op">$</span>W1 &lt;-<span class="st"> </span><span class="kw">ifelse</span>(data<span class="op">$</span>W1 <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(data<span class="op">$</span>W1)[<span class="dv">2</span>], <span class="dv">1</span>, <span class="kw">ifelse</span>(data<span class="op">$</span>W1 <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(data<span class="op">$</span>W1)[<span class="dv">3</span>], <span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb107-3"><a href="optimal-individualized-treatment-regimes.html#cb107-3"></a></span>
<span id="cb107-4"><a href="optimal-individualized-treatment-regimes.html#cb107-4"></a>node_list &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb107-5"><a href="optimal-individualized-treatment-regimes.html#cb107-5"></a>  <span class="dt">W =</span> <span class="kw">c</span>(<span class="st">"W3"</span>, <span class="st">"W4"</span>, <span class="st">"W2"</span>),</span>
<span id="cb107-6"><a href="optimal-individualized-treatment-regimes.html#cb107-6"></a>  <span class="dt">A =</span> <span class="kw">c</span>(<span class="st">"W1"</span>, <span class="st">"A"</span>),</span>
<span id="cb107-7"><a href="optimal-individualized-treatment-regimes.html#cb107-7"></a>  <span class="dt">Y =</span> <span class="st">"Y"</span></span>
<span id="cb107-8"><a href="optimal-individualized-treatment-regimes.html#cb107-8"></a>)</span>
<span id="cb107-9"><a href="optimal-individualized-treatment-regimes.html#cb107-9"></a>node_list</span>
<span id="cb107-10"><a href="optimal-individualized-treatment-regimes.html#cb107-10"></a><span class="op">$</span>W</span>
<span id="cb107-11"><a href="optimal-individualized-treatment-regimes.html#cb107-11"></a>[<span class="dv">1</span>] <span class="st">"W3"</span> <span class="st">"W4"</span> <span class="st">"W2"</span></span>
<span id="cb107-12"><a href="optimal-individualized-treatment-regimes.html#cb107-12"></a></span>
<span id="cb107-13"><a href="optimal-individualized-treatment-regimes.html#cb107-13"></a><span class="op">$</span>A</span>
<span id="cb107-14"><a href="optimal-individualized-treatment-regimes.html#cb107-14"></a>[<span class="dv">1</span>] <span class="st">"W1"</span> <span class="st">"A"</span> </span>
<span id="cb107-15"><a href="optimal-individualized-treatment-regimes.html#cb107-15"></a></span>
<span id="cb107-16"><a href="optimal-individualized-treatment-regimes.html#cb107-16"></a><span class="op">$</span>Y</span>
<span id="cb107-17"><a href="optimal-individualized-treatment-regimes.html#cb107-17"></a>[<span class="dv">1</span>] <span class="st">"Y"</span></span></code></pre></div>
<ul>
<li><p>Note that our node list now includes <span class="math inline">\(W_1\)</span> as treatments as well!</p></li>
<li><p>Don’t worry, we will still properly adjust for all baseline covariates when
considering <span class="math inline">\(A\)</span> as treatment.</p></li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<div id="targeted-estimation-2" class="section level4">
<h4>
<span class="header-section-number">5.7.4.1</span> Targeted Estimation<a class="anchor" aria-label="anchor" href="#targeted-estimation-2"><i class="fas fa-link"></i></a>
</h4>
<p>We will initialize a specification for the TMLE of our parameter of
interest (called a <code>tmle3_Spec</code> in the <code>tlverse</code> nomenclature) simply by calling
<code>tmle3_mopttx_vim</code>.</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec_vim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_vim.html">tmle3_mopttx_vim</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W2"</span><span class="op">)</span>,
  type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  maximize <span class="op">=</span> <span class="cn">FALSE</span>,
  method <span class="op">=</span> <span class="st">"SL"</span>,
  complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># fit the TML estimator</span>
<span class="va">vim_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3_vim.html">tmle3_vim</a></span><span class="op">(</span><span class="va">tmle_spec_vim</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span>,
  adjust_for_other_A <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="optimal-individualized-treatment-regimes.html#cb109-1"></a><span class="co"># see results:</span></span>
<span id="cb109-2"><a href="optimal-individualized-treatment-regimes.html#cb109-2"></a><span class="kw">print</span>(vim_results)</span>
<span id="cb109-3"><a href="optimal-individualized-treatment-regimes.html#cb109-3"></a>   type                param   init_est  tmle_est       se      lower</span>
<span id="cb109-4"><a href="optimal-individualized-treatment-regimes.html#cb109-4"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span>ATE E[Y_{A=<span class="ot">NULL</span>}] <span class="op">-</span><span class="st"> </span>E[Y] <span class="fl">-0.0128837</span> <span class="fl">-0.051833</span> <span class="fl">0.021934</span> <span class="fl">-0.0948231</span></span>
<span id="cb109-5"><a href="optimal-individualized-treatment-regimes.html#cb109-5"></a><span class="dv">2</span><span class="op">:</span><span class="st">  </span>ATE E[Y_{A=<span class="ot">NULL</span>}] <span class="op">-</span><span class="st"> </span>E[Y] <span class="fl">-0.0022747</span>  <span class="fl">0.036924</span> <span class="fl">0.017144</span>  <span class="fl">0.0033228</span></span>
<span id="cb109-6"><a href="optimal-individualized-treatment-regimes.html#cb109-6"></a>        upper psi_transformed lower_transformed upper_transformed  A</span>
<span id="cb109-7"><a href="optimal-individualized-treatment-regimes.html#cb109-7"></a><span class="dv">1</span><span class="op">:</span><span class="st"> </span><span class="fl">-0.0088424</span>       <span class="fl">-0.051833</span>        <span class="fl">-0.0948231</span>        <span class="fl">-0.0088424</span> W1</span>
<span id="cb109-8"><a href="optimal-individualized-treatment-regimes.html#cb109-8"></a><span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="fl">0.0705248</span>        <span class="fl">0.036924</span>         <span class="fl">0.0033228</span>         <span class="fl">0.0705248</span>  A</span>
<span id="cb109-9"><a href="optimal-individualized-treatment-regimes.html#cb109-9"></a>             W  Z_stat      p_nz p_nz_corrected</span>
<span id="cb109-10"><a href="optimal-individualized-treatment-regimes.html#cb109-10"></a><span class="dv">1</span><span class="op">:</span><span class="st">  </span>W3,W4,W2,A <span class="fl">-2.3631</span> <span class="fl">0.0090615</span>       <span class="fl">0.015629</span></span>
<span id="cb109-11"><a href="optimal-individualized-treatment-regimes.html#cb109-11"></a><span class="dv">2</span><span class="op">:</span><span class="st"> </span>W3,W4,W2,W1  <span class="fl">2.1538</span> <span class="fl">0.0156285</span>       <span class="fl">0.015629</span></span></code></pre></div>
<p><br></p>
<p>The final result of <code>tmle3_vim</code> with the <code>tmle3mopttx</code> spec is an ordered list
of mean outcomes under the optimal individualized treatment for all categorical
covariates in our dataset.</p>
<p><br></p>
<hr>
<p><br></p>
</div>
</div>
</div>
<div id="exercise" class="section level2">
<h2>
<span class="header-section-number">5.8</span> Exercise<a class="anchor" aria-label="anchor" href="#exercise"><i class="fas fa-link"></i></a>
</h2>
<div id="real-world-data-and-tmle3mopttx" class="section level3">
<h3>
<span class="header-section-number">5.8.1</span> Real World Data and <code>tmle3mopttx</code><a class="anchor" aria-label="anchor" href="#real-world-data-and-tmle3mopttx"><i class="fas fa-link"></i></a>
</h3>
<p>Finally, we cement everything we learned so far with a real data application.</p>
<p>As in the previous sections, we will be using the WASH Benefits data,
corresponding to the effect of water quality, sanitation, hand washing, and
nutritional interventions on child development in rural Bangladesh trial.</p>
<p>The main aim of the cluster-randomized controlled trial was to assess the
impact of six intervention groups, including:</p>
<ol style="list-style-type: decimal">
<li><p>Control</p></li>
<li><p>Handwashing with soap</p></li>
<li><p>Improved nutrition through counselling and provision of lipid-based nutrient supplements</p></li>
<li><p>Combined water, sanitation, handwashing, and nutrition.</p></li>
<li><p>Improved sanitation</p></li>
<li><p>Combined water, sanitation, and handwashing</p></li>
<li><p>Chlorinated drinking water</p></li>
</ol>
<p>We aim to estimate the optimal ITR and the corresponding value under the optimal ITR
for the main intervention in WASH Benefits data.</p>
<p>Our outcome of interest is the weight-for-height Z-score, whereas our treatment is
the six intervention groups aimed at improving living conditions.</p>
<p><br></p>
<hr>
<p><br></p>
<p>Questions:</p>
<ol style="list-style-type: decimal">
<li><p>Define <span class="math inline">\(V\)</span> as mother’s education (<code>momedu</code>), current living conditions (<code>floor</code>),
and possession of material items including the refrigerator (<code>asset_refrig</code>).
Do we want to minimize or maximize the outcome? Which blip type should we use?
Construct an appropriate <code>sl3</code> library for <span class="math inline">\(A\)</span>, <span class="math inline">\(Y\)</span> and <span class="math inline">\(B\)</span>.</p></li>
<li><p>Based on the <span class="math inline">\(V\)</span> defined in the previous question, estimate the mean under the ITR for
the main randomized intervention used in the WASH Benefits trial
with weight-for-height Z-score as the outcome. What’s the TMLE value of the optimal ITR?
How does it change from the initial estimate? Which intervention is the most dominant?
Why do you think that is?</p></li>
<li><p>Using the same formulation as in questions 1 and 2, estimate the realistic optimal ITR
and the corresponding value of the realistic ITR. Did the results change? Which intervention
is the most dominant under realistic rules? Why do you think that is?</p></li>
</ol>
<p><br></p>
<hr>
<p><br></p>
</div>
<div id="solutions" class="section level3">
<h3>
<span class="header-section-number">5.8.2</span> Solutions<a class="anchor" aria-label="anchor" href="#solutions"><i class="fas fa-link"></i></a>
</h3>
<p>To start, let’s load the data, convert all columns to be of class <code>numeric</code>,
and take a quick look at it:</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">washb_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/tlverse/tlverse-data/master/wash-benefits/washb_data.csv"</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">washb_data</span> <span class="op">&lt;-</span> <span class="va">washb_data</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">momage</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">washb_data</span>, <span class="fl">3</span><span class="op">)</span></code></pre></div>
<p>As before, we specify the NPSEM via the <code>node_list</code> object.</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">node_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"whz"</span>, <span class="st">"tr"</span>, <span class="st">"momheight"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,
  A <span class="op">=</span> <span class="st">"tr"</span>, Y <span class="op">=</span> <span class="st">"whz"</span>
<span class="op">)</span></code></pre></div>
<p>We pick few potential effect modifiers, including mother’s education, current
living conditions (floor), and possession of material items including the refrigerator.
We concentrate of these covariates as they might be indicative of the socio-economic status
of individuals involved in the trial. We can explore the distribution of our <span class="math inline">\(V\)</span>, <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span>:</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># V1, V2 and V3:</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">momedu</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">floor</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">asset_refrig</span><span class="op">)</span>

<span class="co"># A:</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">tr</span><span class="op">)</span>

<span class="co"># Y:</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">whz</span><span class="op">)</span></code></pre></div>
<p>We specify a simple library for the outcome regression, propensity score
and the blip function. Since our treatment is categorical, we need to define a
multinomial learner for <span class="math inline">\(A\)</span> and multivariate learner for <span class="math inline">\(B\)</span>. We
will define the <code>xgboost</code> over a grid of parameters, and initialize a mean learner.</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Initialize few of the learners:</span>
<span class="va">grid_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  nrounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span>,
  eta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">grid_params</span>, KEEP.OUT.ATTRS <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">xgb_learners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">grid</span>, MARGIN <span class="op">=</span> <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">params_tune</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">Lrnr_xgboost</span><span class="op">$</span><span class="va">new</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="va">params_tune</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">lrn_mean</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_mean.html">Lrnr_mean</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>

<span class="co">## Define the Q learner, which is just a regular learner:</span>
<span class="va">Q_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>,
    <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>, <span class="va">lrn_mean</span>
  <span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="co">## Define the g learner, which is a multinomial learner:</span>
<span class="co"># specify the appropriate loss of the multinomial learner:</span>
<span class="va">mn_metalearner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Lrnr_solnp</span>,
  eval_function <span class="op">=</span> <span class="va">loss_loglik_multinomial</span>,
  learner_function <span class="op">=</span> <span class="va">metalearner_linear_multinomial</span>
<span class="op">)</span>
<span class="va">g_learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Lrnr_sl</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>, <span class="va">lrn_mean</span><span class="op">)</span>, <span class="va">mn_metalearner</span><span class="op">)</span>

<span class="co">## Define the Blip learner, which is a multivariate learner:</span>
<span class="va">learners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>,
  <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>, <span class="va">lrn_mean</span>
<span class="op">)</span>
<span class="va">b_learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/create_mv_learners.html">create_mv_learners</a></span><span class="op">(</span>learners <span class="op">=</span> <span class="va">learners</span><span class="op">)</span>

<span class="va">learner_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Q_learner</span>, A <span class="op">=</span> <span class="va">g_learner</span>, B <span class="op">=</span> <span class="va">b_learner</span><span class="op">)</span></code></pre></div>
<p>As seen before, we initialize the <code>tmle3_mopttx_blip_revere</code> Spec in order to
answer Question 1. We want to maximize our outcome, with higher the weight-for-height Z-score
the better. We will also use <code>blip2</code> as the blip type, but note that we could have used <code>blip1</code>
as well since “Control” is a good reference category.</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Question 2:</span>

<span class="co"># Initialize a tmle specification</span>
<span class="va">tmle_spec_Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"momedu"</span>, <span class="st">"floor"</span>, <span class="st">"asset_refrig"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>, maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># Fit the TML estimator.</span>
<span class="va">fit_Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec_Q</span>, data <span class="op">=</span> <span class="va">washb_data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span>
<span class="va">fit_Q</span>

<span class="co"># Which intervention is the most dominant?</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tmle_spec_Q</span><span class="op">$</span><span class="va">return_rule</span><span class="op">)</span></code></pre></div>
<p>Using the same formulation as before, we estimate the realistic optimal ITR
and the corresponding value of the realistic ITR:</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Question 3:</span>

<span class="co"># Initialize a tmle specification with "realistic=TRUE":</span>
<span class="va">tmle_spec_Q_realistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"momedu"</span>, <span class="st">"floor"</span>, <span class="st">"asset_refrig"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>, maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>

<span class="co"># Fit the TML estimator.</span>
<span class="va">fit_Q_realistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec_Q_realistic</span>, data <span class="op">=</span> <span class="va">washb_data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span>
<span class="va">fit_Q_realistic</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tmle_spec_Q_realistic</span><span class="op">$</span><span class="va">return_rule</span><span class="op">)</span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="tmle3.html"><span class="header-section-number">4</span> The TMLE Framework (Brief Review)</a></div>
<div class="next"><a href="stochastic-treatment-regimes-optional.html"><span class="header-section-number">6</span> Stochastic Treatment Regimes (optional)</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#optimal-individualized-treatment-regimes"><span class="header-section-number">5</span> Optimal Individualized Treatment Regimes</a></li>
<li><a class="nav-link" href="#learning-objectives-3"><span class="header-section-number">5.1</span> Learning Objectives</a></li>
<li><a class="nav-link" href="#introduction-1"><span class="header-section-number">5.2</span> Introduction</a></li>
<li><a class="nav-link" href="#data-structure-and-notation"><span class="header-section-number">5.3</span> Data Structure and Notation</a></li>
<li>
<a class="nav-link" href="#causal-effect-of-an-oit"><span class="header-section-number">5.4</span> Causal Effect of an OIT</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#identification-and-statistical-estimand"><span class="header-section-number">5.4.1</span> Identification and Statistical Estimand</a></li>
<li><a class="nav-link" href="#high-level-idea"><span class="header-section-number">5.4.2</span> High-level idea</a></li>
<li><a class="nav-link" href="#why-cv-tmle"><span class="header-section-number">5.4.3</span> Why CV-TMLE?</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#binary-treatment"><span class="header-section-number">5.5</span> Binary Treatment</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#causal-effect-of-oit-with-binary-a"><span class="header-section-number">5.5.1</span> Causal Effect of OIT with Binary A</a></li></ul>
</li>
<li>
<a class="nav-link" href="#categorical-treatment"><span class="header-section-number">5.6</span> Categorical Treatment</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#causal-effect-of-oit-with-categorical-a"><span class="header-section-number">5.6.1</span> Causal Effect of OIT with Categorical A</a></li></ul>
</li>
<li>
<a class="nav-link" href="#extensions"><span class="header-section-number">5.7</span> Extensions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#simpler-rules"><span class="header-section-number">5.7.1</span> Simpler Rules</a></li>
<li><a class="nav-link" href="#realistic-optimal-individual-regimes"><span class="header-section-number">5.7.2</span> Realistic Optimal Individual Regimes</a></li>
<li><a class="nav-link" href="#missingness-and-tmle3mopttx"><span class="header-section-number">5.7.3</span> Missingness and tmle3mopttx</a></li>
<li><a class="nav-link" href="#variable-importance-analysis"><span class="header-section-number">5.7.4</span> Variable Importance Analysis</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#exercise"><span class="header-section-number">5.8</span> Exercise</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#real-world-data-and-tmle3mopttx"><span class="header-section-number">5.8.1</span> Real World Data and tmle3mopttx</a></li>
<li><a class="nav-link" href="#solutions"><span class="header-section-number">5.8.2</span> Solutions</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/tlverse/tlverse-workshops/blob/master/06-tmle3mopttx.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/tlverse/tlverse-workshops/edit/master/06-tmle3mopttx.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>[ACIC 2022] Targeted Learning in the <code>tlverse</code></strong>: Causal Inference Meets Machine Learning" was written by Mark van der Laan, Alan Hubbard, Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips. It was last built on updated: May 23, 2022.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
